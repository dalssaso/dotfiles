#+TITLE: Doom Emacs Configuration
#+AUTHOR: Henrique Dalssaso
#+PROPERTY: header-args:emacs-lisp :tangle yes :results silent

This is my literate Doom Emacs configuration. It tangles to =config.el= automatically
when Doom loads (via the =literate= module).

* Machine Context

Load machine-specific variables generated by chezmoi.

#+begin_src emacs-lisp
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-

;; Load machine context (generated by chezmoi)
(let ((context-file (expand-file-name "~/.local/state/machine-context.el")))
  (when (file-exists-p context-file)
    (load context-file nil t)))
#+end_src

* Personal Info

#+begin_src emacs-lisp
(setq user-full-name "Henrique Dalssaso"
      user-mail-address (if (hd/work-machine-p)
                            hd/work-email
                          hd/personal-email))
#+end_src

* UI & Theme
** Fonts

Using Monaspace font family with Radon for italics.

#+begin_src emacs-lisp
(setq doom-font (font-spec :family "Monaspace Neon" :size 15)
      doom-variable-pitch-font (font-spec :family "SF Pro Text" :size 15)
      doom-symbol-font (font-spec :family "MesloLGS Nerd Font Mono")
      doom-big-font (font-spec :family "Monaspace Neon" :size 24))

(defun hd/monaspace-radon-italics-and-comments ()
  "Use Monaspace Radon for italic faces and comments."
  (let ((radon "Monaspace Radon")
        (neon "Monaspace Neon"))
    (set-face-attribute 'fixed-pitch nil :family neon)
    (set-face-attribute 'italic nil :family radon :slant 'italic)
    (set-face-attribute 'font-lock-comment-face nil :family radon :slant 'italic)
    (set-face-attribute 'font-lock-comment-delimiter-face nil :family radon :slant 'italic)
    (set-face-attribute 'font-lock-doc-face nil :family radon :slant 'italic)))

(add-hook 'doom-load-theme-hook #'hd/monaspace-radon-italics-and-comments)
#+end_src

** Theme

Catppuccin Mocha flavor.

#+begin_src emacs-lisp
(setq catppuccin-flavor 'mocha)
(setq doom-theme 'catppuccin)
#+end_src

** Line Numbers

#+begin_src emacs-lisp
(setq display-line-numbers-type t)
#+end_src

* Editor Settings
** Shell Configuration

#+begin_src emacs-lisp
(setq shell-file-name (executable-find "bash"))
(setq-default vterm-shell (executable-find "fish"))
(setq-default explicit-shell-file-name (executable-find "fish"))
#+end_src

** Treesitter

#+begin_src emacs-lisp
(after! treesit
  (setq treesit-font-lock-level 3))
#+end_src

** Projectile

#+begin_src emacs-lisp
(setq projectile-project-search-path '("~/src/work" "~/src/personal" "~/.local/share/chezmoi"))
#+end_src

** Auth Sources

#+begin_src emacs-lisp
(setq auth-sources '("~/.authinfo.gpg"))
#+end_src

* Packages
** Wakatime

#+begin_src emacs-lisp
(global-wakatime-mode)
#+end_src

* Chezmoi Integration

Integration with chezmoi dotfile manager. Provides template overlays,
diff/ediff tools, and convenient file operations.

** Age Encryption

Transparent age encryption support for editing encrypted chezmoi files.
Uses the same identity file as chezmoi (~/.config/chezmoi/key.txt).

#+begin_src emacs-lisp
(use-package! age
  :demand t
  :config
  ;; Use the same identity file as chezmoi
  (setq age-program "age"
        age-default-identity "~/.config/chezmoi/key.txt"
        age-default-recipient "~/.config/chezmoi/key.txt")

  ;; Enable age.el globally for .age files
  (age-file-enable))
#+end_src

** Chezmoi Package

#+begin_src emacs-lisp
(use-package! chezmoi
  :defer t
  :config
  ;; Enable template value overlays in chezmoi source files
  (setq chezmoi-template-display-p t))

;; Keybindings under SPC c z
(map! :leader
      (:prefix ("c z" . "chezmoi")
       :desc "Find file" "f" #'chezmoi-find
       :desc "Write (apply)" "w" #'chezmoi-write
       :desc "Diff" "d" #'chezmoi-diff
       :desc "Ediff" "e" #'chezmoi-ediff
       :desc "Sync" "s" #'chezmoi-sync-files
       :desc "Open in magit" "g" #'chezmoi-magit-status
       :desc "Toggle template" "t" #'chezmoi-template-buffer-display))

;; Auto-enable chezmoi-mode for files in chezmoi source directory
(add-hook 'find-file-hook
          (lambda ()
            (when (and buffer-file-name
                       (string-match-p "/\\.local/share/chezmoi/" buffer-file-name))
              (chezmoi-mode 1))))
#+end_src

* Brewfile Mode

Syntax highlighting for Homebrew Brewfiles. Uses ruby-mode as base with
additional highlighting for Brewfile-specific keywords.

#+begin_src emacs-lisp
(define-derived-mode brewfile-mode ruby-mode "Brewfile"
  "Major mode for editing Homebrew Brewfiles."
  (font-lock-add-keywords
   nil
   '(;; Brewfile commands
     ("^\\s-*\\(tap\\|brew\\|cask\\|mas\\)\\s-" 1 font-lock-keyword-face)
     ;; Package names (strings after commands)
     ("\\(tap\\|brew\\|cask\\|mas\\)\\s-+\\(\"[^\"]+\"\\)" 2 font-lock-string-face)
     ;; Options keywords
     ("\\b\\(args\\|restart_service\\|link\\|conflicts_with\\):" 1 font-lock-builtin-face)
     ;; Common option values
     (":\\(changed\\|loaded\\|no_quarantine\\)\\b" 1 font-lock-constant-face)
     ;; App Store IDs
     ("\\bid:\\s-*\\([0-9]+\\)" 1 font-lock-constant-face))))

;; Associate Brewfile patterns with brewfile-mode
(add-to-list 'auto-mode-alist '("Brewfile\\'" . brewfile-mode))
(add-to-list 'auto-mode-alist '("Brewfile\\.[a-z]+\\'" . brewfile-mode))
(add-to-list 'auto-mode-alist '("\\.Brewfile\\'" . brewfile-mode))
#+end_src

* Org Visual Enhancements

Make org-mode look beautiful with modern styling, variable-pitch fonts for prose,
and visual hierarchy through heading sizes.

** Org Modern

Replace org-superstar with org-modern for better visual styling of headlines,
keywords, tables, and source blocks. Uses efficient text properties instead of
character composition.

#+begin_src emacs-lisp
(use-package! org-modern
  :hook (org-mode . org-modern-mode)
  :config
  (setq org-modern-star '("◉" "○" "◈" "◇" "✳")
        org-modern-list '((43 . "➤") (45 . "–") (42 . "•"))
        org-modern-tag t
        org-modern-priority t
        org-modern-todo t
        org-modern-table t))
#+end_src

** Org Appear

Show emphasis markers only when cursor is on them. This gives you clean
rendered text while still being able to edit markers easily.

#+begin_src emacs-lisp
(use-package! org-appear
  :hook (org-mode . org-appear-mode)
  :config
  (setq org-appear-autoemphasis t
        org-appear-autolinks t
        org-appear-autosubmarkers t))
#+end_src

** Visual Settings

#+begin_src emacs-lisp
(after! org
  ;; Hide emphasis markers (*bold*, /italic/, etc.) for cleaner look
  (setq org-hide-emphasis-markers t)

  ;; Custom ellipsis for folded sections
  (setq org-ellipsis " ▾")

  ;; Prettier priorities
  (setq org-priority-faces
        '((?A . (:foreground "#ff6b6b" :weight bold))
          (?B . (:foreground "#feca57"))
          (?C . (:foreground "#48dbfb"))))

  ;; Start org files with all headings folded
  (setq org-startup-folded 'content)

  ;; Indent content under headings
  (setq org-startup-indented t)

  ;; Don't show line numbers in org-mode (cleaner for writing)
  (add-hook 'org-mode-hook (lambda () (display-line-numbers-mode -1))))
#+end_src

** Mixed Pitch (Variable + Fixed Fonts)

Use variable-pitch (proportional) font for prose and fixed-pitch for code,
tables, and other elements that need alignment.

#+begin_src emacs-lisp
(add-hook 'org-mode-hook 'variable-pitch-mode)
(add-hook 'org-mode-hook 'visual-line-mode)

(after! org
  ;; Ensure these elements stay in fixed-pitch
  (custom-set-faces!
    '(org-block :inherit fixed-pitch)
    '(org-code :inherit fixed-pitch)
    '(org-table :inherit fixed-pitch)
    '(org-verbatim :inherit fixed-pitch)
    '(org-special-keyword :inherit fixed-pitch)
    '(org-meta-line :inherit fixed-pitch)
    '(org-checkbox :inherit fixed-pitch)
    '(org-property-value :inherit fixed-pitch)
    '(org-drawer :inherit fixed-pitch)
    '(org-date :inherit fixed-pitch)))
#+end_src

** Heading Sizes

Create visual hierarchy with scaled heading sizes.

#+begin_src emacs-lisp
(after! org
  (custom-set-faces!
    '(org-level-1 :inherit outline-1 :height 1.4)
    '(org-level-2 :inherit outline-2 :height 1.3)
    '(org-level-3 :inherit outline-3 :height 1.2)
    '(org-level-4 :inherit outline-4 :height 1.1)
    '(org-level-5 :inherit outline-5 :height 1.05)
    '(org-document-title :height 1.6 :weight bold)))
#+end_src

** Centered Writing (Olivetti)

Center org content like a word processor with comfortable margins.
Use =SPC t z= for additional zen/focus mode (hides modeline, etc.).

#+begin_src emacs-lisp
(use-package! olivetti
  :hook (org-mode . olivetti-mode)
  :config
  (setq olivetti-body-width 100
        olivetti-minimum-body-width 80
        olivetti-style 'fancy))
#+end_src

* Org Mode
** Path Configuration

Set org directories based on machine type.

#+begin_src emacs-lisp
(setq org-directory (if (hd/work-machine-p)
                        hd/org-work-dir
                      (expand-file-name "agenda" hd/org-personal-dir)))

(setq org-agenda-files
      (if (hd/work-machine-p)
          (list (expand-file-name "agenda.org" hd/org-work-dir)
                (expand-file-name "inbox.org" hd/org-work-dir))
        (list (expand-file-name "agenda.org" (expand-file-name "agenda" hd/org-personal-dir))
              (expand-file-name "inbox.org" (expand-file-name "agenda" hd/org-personal-dir)))))
#+end_src

** Tags

Define tag shortcuts for fast tagging.

#+begin_src emacs-lisp
(after! org
  (setq org-tag-alist
        (if (hd/work-machine-p)
            '(("@meeting" . ?m) ("@project" . ?p) ("@review" . ?r)
              ("@admin" . ?a) ("@pending" . ?w) ("@report" . ?d))
          '(("@home" . ?h) ("@errands" . ?e) ("@online" . ?o)
            ("@health" . ?H) ("@finance" . ?f) ("@someday" . ?s)
            ("@waiting" . ?w) ("@learning" . ?l)))))
#+end_src

** Capture Templates

#+begin_src emacs-lisp
(after! org
  (setq org-capture-templates
        (if (hd/work-machine-p)
            ;; Work templates
            '(("t" "Task" entry (file "inbox.org")
               "* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("m" "Meeting" entry (file "inbox.org")
               "* TODO %? :@meeting:\nSCHEDULED: %^t\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("p" "Pending Reply" entry (file "inbox.org")
               "* TODO %? :@pending:\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("r" "Review" entry (file "inbox.org")
               "* TODO %? :@review:\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("a" "Admin" entry (file "inbox.org")
               "* TODO %? :@admin:\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("d" "Report" entry (file "inbox.org")
               "* TODO %? :@report:\n:PROPERTIES:\n:CREATED: %U\n:END:"))
          ;; Personal templates
          '(("t" "Task" entry (file "inbox.org")
             "* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("h" "Home" entry (file "inbox.org")
             "* TODO %? :@home:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("e" "Errand" entry (file "inbox.org")
             "* TODO %? :@errands:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("o" "Online" entry (file "inbox.org")
             "* TODO %? :@online:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("H" "Health" entry (file "inbox.org")
             "* TODO %? :@health:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("f" "Finance" entry (file "inbox.org")
             "* TODO %? :@finance:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("s" "Someday" entry (file "inbox.org")
             "* TODO %? :@someday:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("l" "Learning" entry (file "inbox.org")
             "* TODO %? :@learning:\n:PROPERTIES:\n:CREATED: %U\n:END:")))))
#+end_src

** Custom Agenda Commands

#+begin_src emacs-lisp
(after! org-agenda
  (setq org-agenda-custom-commands
        (if (hd/work-machine-p)
            ;; Work agenda commands
            '(("W" "Work Agenda"
               ((agenda "" ((org-agenda-span 'day)))
                (tags-todo "+@pending" ((org-agenda-overriding-header "Awaiting Reply")))
                (tags-todo "+@meeting" ((org-agenda-overriding-header "Meetings")))
                (tags-todo "+@review" ((org-agenda-overriding-header "Reviews")))
                (tags-todo "+@project" ((org-agenda-overriding-header "Projects")))
                (tags-todo "+@admin" ((org-agenda-overriding-header "Admin")))
                (tags-todo "+@report" ((org-agenda-overriding-header "Reports")))))
              ("Wp" "Pending" tags-todo "+@pending")
              ("Wm" "Meetings" tags-todo "+@meeting")
              ("Wr" "Reviews" tags-todo "+@review"))
          ;; Personal agenda commands
          '(("P" "Personal Agenda"
             ((agenda "" ((org-agenda-span 'day)))
              (tags-todo "+@waiting" ((org-agenda-overriding-header "Waiting")))
              (tags-todo "+@errands" ((org-agenda-overriding-header "Errands")))
              (tags-todo "+@home" ((org-agenda-overriding-header "Home")))
              (tags-todo "+@health" ((org-agenda-overriding-header "Health")))
              (tags-todo "+@finance" ((org-agenda-overriding-header "Finance")))
              (tags-todo "+@learning" ((org-agenda-overriding-header "Learning")))))
            ("Ps" "Someday" tags-todo "+@someday")
            ("Pw" "Waiting" tags-todo "+@waiting")))))
#+end_src

** Archive Settings

#+begin_src emacs-lisp
(after! org
  (setq org-archive-location
        (if (hd/work-machine-p)
            (concat (expand-file-name "archive.org" hd/org-work-dir) "::* Archive")
          (concat (expand-file-name "archive.org" (expand-file-name "agenda" hd/org-personal-dir)) "::* Archive"))))
#+end_src

* Org-roam
** Directory Setup

#+begin_src emacs-lisp
(after! org-roam
  (setq org-roam-directory (expand-file-name "roam" hd/org-personal-dir))
  (setq org-roam-dailies-directory (expand-file-name "daily" hd/org-personal-dir)))
#+end_src

** Dailies Capture Templates

#+begin_src emacs-lisp
(after! org-roam-dailies
  (setq org-roam-dailies-capture-templates
        '(("d" "default" entry
           "* %<%H:%M> %?"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n"))
          ("t" "task" entry
           "* TODO %?"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n"))
          ("j" "journal" entry
           "* %<%H:%M> Journal :journal:\n%?"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n")))))
#+end_src

** Keybindings

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("r" . "roam")
       :desc "Find node" "f" #'org-roam-node-find
       :desc "Insert link" "i" #'org-roam-node-insert
       :desc "Today" "t" #'org-roam-dailies-goto-today
       :desc "Yesterday" "y" #'org-roam-dailies-goto-yesterday
       :desc "Date" "d" #'org-roam-dailies-goto-date
       :desc "Capture today" "c" #'org-roam-dailies-capture-today))
#+end_src

** Git Auto-sync

Automatically commit and push changes to org-personal repo.

*** Core Functions

#+begin_src emacs-lisp
(defvar hd/org-sync-timer nil "Timer for debounced commit.")
(defvar hd/org-sync-delay 60 "Seconds to wait after save before commit.")

(defun hd/org-sync-commit-and-push ()
  "Stage, commit, and push changes."
  (let ((default-directory hd/org-personal-dir))
    (when (and (bound-and-true-p hd/org-personal-dir)
               (file-exists-p (expand-file-name ".git" hd/org-personal-dir)))
      (start-process "org-sync-add" nil "git" "add" "-A")
      (set-process-sentinel
       (start-process "org-sync-commit" nil "git" "commit" "-m"
                      (format "auto: %s" (format-time-string "%Y-%m-%d %H:%M")))
       (lambda (proc event)
         (when (string-match-p "finished" event)
           (start-process "org-sync-push" nil "git" "push")))))))

(defun hd/org-sync-pull ()
  "Commit pending changes, then pull latest."
  (let ((default-directory hd/org-personal-dir))
    (when (and (bound-and-true-p hd/org-personal-dir)
               (file-exists-p (expand-file-name ".git" hd/org-personal-dir)))
      ;; Cancel pending timer and commit first
      (when hd/org-sync-timer
        (cancel-timer hd/org-sync-timer)
        (setq hd/org-sync-timer nil))
      ;; Synchronous commit before pull
      (call-process "git" nil nil nil "add" "-A")
      (call-process "git" nil nil nil "commit" "-m"
                    (format "auto: %s" (format-time-string "%Y-%m-%d %H:%M")))
      ;; Pull with rebase
      (call-process "git" nil nil nil "pull" "--rebase"))))

(defun hd/org-sync-schedule-commit ()
  "Schedule a commit after delay (debounced)."
  (when hd/org-sync-timer (cancel-timer hd/org-sync-timer))
  (setq hd/org-sync-timer
        (run-with-timer hd/org-sync-delay nil #'hd/org-sync-commit-and-push)))
#+end_src

*** Save Hook

#+begin_src emacs-lisp
(defun hd/org-sync-after-save ()
  "Trigger sync if file is in org-personal."
  (when (and buffer-file-name
             (bound-and-true-p hd/org-personal-dir)
             (string-prefix-p (expand-file-name hd/org-personal-dir)
                              (expand-file-name buffer-file-name)))
    (hd/org-sync-schedule-commit)))

(add-hook 'after-save-hook #'hd/org-sync-after-save)
#+end_src

*** Pull Before Open

#+begin_src emacs-lisp
(after! org-roam
  (advice-add 'org-roam-node-find :before (lambda (&rest _) (hd/org-sync-pull)))
  (advice-add 'org-roam-dailies-goto-today :before (lambda (&rest _) (hd/org-sync-pull)))
  (advice-add 'org-roam-dailies-goto-yesterday :before (lambda (&rest _) (hd/org-sync-pull)))
  (advice-add 'org-roam-dailies-goto-date :before (lambda (&rest _) (hd/org-sync-pull))))
#+end_src