#+TITLE: Doom Emacs Configuration
#+AUTHOR: Henrique Dalssaso
#+PROPERTY: header-args:emacs-lisp :tangle yes :results silent

This is my literate Doom Emacs configuration. It tangles to =config.el= automatically
when Doom loads (via the =literate= module).

* Machine Context

Load machine-specific variables generated by chezmoi.

#+begin_src emacs-lisp
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-

;; Load machine context (generated by chezmoi)
(let ((context-file (expand-file-name "~/.local/state/machine-context.el")))
  (when (file-exists-p context-file)
    (load context-file nil t)))
#+end_src

* Personal Info

#+begin_src emacs-lisp
(setq user-full-name "Henrique Dalssaso"
      user-mail-address (if (hd/work-machine-p)
                            hd/work-email
                          hd/personal-email))
#+end_src

* UI & Theme
** Fonts

Using Monaspace font family with Radon for italics.

#+begin_src emacs-lisp
(setq doom-font (font-spec :family "Monaspace Neon" :size 15)
      doom-variable-pitch-font (font-spec :family "SF Pro Text" :size 15)
      doom-symbol-font (font-spec :family "MesloLGS Nerd Font Mono")
      doom-big-font (font-spec :family "Monaspace Neon" :size 24))

(defun hd/monaspace-radon-italics-and-comments ()
  "Use Monaspace Radon for italic faces and comments."
  (let ((radon "Monaspace Radon")
        (neon "Monaspace Neon"))
    (set-face-attribute 'fixed-pitch nil :family neon)
    (set-face-attribute 'italic nil :family radon :slant 'italic)
    (set-face-attribute 'font-lock-comment-face nil :family radon :slant 'italic)
    (set-face-attribute 'font-lock-comment-delimiter-face nil :family radon :slant 'italic)
    (set-face-attribute 'font-lock-doc-face nil :family radon :slant 'italic)))

(add-hook 'doom-load-theme-hook #'hd/monaspace-radon-italics-and-comments)
#+end_src

** Theme

Catppuccin Mocha flavor.

#+begin_src emacs-lisp
(setq catppuccin-flavor 'mocha)
(setq doom-theme 'catppuccin)
#+end_src

** Line Numbers

#+begin_src emacs-lisp
(setq display-line-numbers-type t)
#+end_src

* Editor Settings
** Shell Configuration

#+begin_src emacs-lisp
(setq shell-file-name (executable-find "bash"))
(setq-default vterm-shell (executable-find "fish"))
(setq-default explicit-shell-file-name (executable-find "fish"))
#+end_src

** Spell Checking

Multi-language spell checking with hunspell. Supports en_US, en_GB, and pt_BR.

Dictionaries are installed automatically by chezmoi (see =run_once_after_install-hunspell-dictionaries.fish=).
They are placed in =~/Library/Spelling/=.

#+begin_src emacs-lisp
(after! ispell
  ;; Doom sets ispell-program-name to "hunspell" via +hunspell flag
  ;; We just need to configure dictionaries

  ;; Set dictionary search path for macOS
  (setenv "DICPATH"
          (string-join (list (expand-file-name "~/Library/Spelling")
                             "/opt/homebrew/share/hunspell"
                             "/Library/Spelling")
                       ":"))

  ;; Configure available dictionaries for hunspell
  (setq ispell-local-dictionary-alist
        '(("en_US" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_US") nil utf-8)
          ("en_GB" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_GB") nil utf-8)
          ("pt_BR" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "pt_BR") nil utf-8)
          ("multi" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_US,en_GB,pt_BR") nil utf-8)))

  ;; Use multi-dictionary by default (all three languages)
  (setq ispell-dictionary "multi"
        ispell-local-dictionary "multi"))

;; Function to switch spell-check language
(defun hd/switch-spell-dictionary ()
  "Switch between spell-check dictionaries."
  (interactive)
  (let ((dict (completing-read "Dictionary: "
                               '("multi" "en_US" "en_GB" "pt_BR")
                               nil t nil nil "multi")))
    (ispell-kill-ispell t)
    (setq ispell-dictionary dict
          ispell-local-dictionary dict)
    (when (bound-and-true-p flyspell-mode)
      (flyspell-mode -1)
      (flyspell-mode +1))
    (message "Switched to dictionary: %s" dict)))

;; Keybindings for spell checking
;; Note: zg and zw are already bound by Doom to +spell/add-word and +spell/remove-word
(map! :leader
      (:prefix ("S" . "spell")
       :desc "Switch dictionary" "d" #'hd/switch-spell-dictionary
       :desc "Correct word" "c" #'flyspell-correct-at-point
       :desc "Correct previous" "p" #'flyspell-correct-previous
       :desc "Add to dictionary" "a" #'+spell/add-word
       :desc "Remove from dictionary" "r" #'+spell/remove-word
       :desc "Check buffer" "b" #'flyspell-buffer))
#+end_src
** Treesitter

#+begin_src emacs-lisp
(after! treesit
  (setq treesit-font-lock-level 3))
** Formatters & Linters

Configure language-specific formatters (via apheleia) and linters (via flycheck).
With =+lsp= enabled on the format module, LSP formatting is the default.
We override specific modes to use our preferred formatters instead.

*** Python (ruff)

Use ruff for everything: LSP, formatting, and linting.

#+begin_src emacs-lisp
;; Use lsp-mode's built-in ruff client
(after! lsp-mode
  (require 'lsp-ruff nil t)
  ;; Disable other Python LSP servers in favor of ruff
  (setq lsp-disabled-clients '(pyls pylsp pyright mspyls))
  ;; Configure ruff LSP
  (setq lsp-ruff-log-level "warn"
        lsp-ruff-advertize-fix-all t
        lsp-ruff-advertize-organize-imports t
        lsp-ruff-import-strategy "fromEnvironment"))

;; Use ruff for formatting instead of LSP (format + isort in one)
(after! apheleia
  (setf (alist-get 'python-mode apheleia-mode-alist) '(ruff-isort ruff))
  (setf (alist-get 'python-ts-mode apheleia-mode-alist) '(ruff-isort ruff)))
(setq-hook! '(python-mode-hook python-ts-mode-hook)
  +format-with '(ruff-isort ruff))

;; Use ruff for linting via flycheck
(after! flycheck
  (flycheck-define-checker python-ruff
    "A Python syntax and style checker using ruff."
    :command ("ruff" "check" "--output-format=concise" source-original)
    :error-patterns
    ((warning line-start (file-name) ":" line ":" column ": " (id (one-or-more alnum)) " " (message) line-end))
    :modes (python-mode python-ts-mode)
    :predicate (lambda () (buffer-file-name)))
  (add-to-list 'flycheck-checkers 'python-ruff)
  (setq-hook! '(python-mode-hook python-ts-mode-hook)
    flycheck-checker 'python-ruff))
#+end_src

*** JavaScript & CSS (prettier)

Use prettier for JavaScript, TypeScript, and CSS. Prettier automatically
respects project configuration files (.prettierrc, etc.).

#+begin_src emacs-lisp
(after! apheleia
  ;; JavaScript/TypeScript
  (setf (alist-get 'js-mode apheleia-mode-alist) 'prettier-javascript)
  (setf (alist-get 'js-ts-mode apheleia-mode-alist) 'prettier-javascript)
  (setf (alist-get 'typescript-mode apheleia-mode-alist) 'prettier-typescript)
  (setf (alist-get 'typescript-ts-mode apheleia-mode-alist) 'prettier-typescript)
  (setf (alist-get 'tsx-ts-mode apheleia-mode-alist) 'prettier-typescript)

  ;; CSS/SCSS
  (setf (alist-get 'css-mode apheleia-mode-alist) 'prettier-css)
  (setf (alist-get 'css-ts-mode apheleia-mode-alist) 'prettier-css)
  (setf (alist-get 'scss-mode apheleia-mode-alist) 'prettier-scss))

;; Override LSP formatting with prettier for these modes
(setq-hook! '(js-mode-hook js-ts-mode-hook) +format-with 'prettier-javascript)
(setq-hook! '(typescript-mode-hook typescript-ts-mode-hook tsx-ts-mode-hook) +format-with 'prettier-typescript)
(setq-hook! '(css-mode-hook css-ts-mode-hook) +format-with 'prettier-css)
(setq-hook! 'scss-mode-hook +format-with 'prettier-scss)
#+end_src

*** Go (golangci-lint + goimports/gofmt)

Use golangci-lint for linting (already configured by Doom's go module).
For formatting, use project's golangci-lint config if available, otherwise
fall back to goimports then gofmt.

#+begin_src emacs-lisp
(after! apheleia
  ;; Define a smart Go formatter that uses golangci-lint if config exists
  (setf (alist-get 'golangci-lint-fmt apheleia-formatters)
        '("golangci-lint" "fmt" "--stdin" filepath))

  ;; Use goimports as default (includes gofmt)
  (setf (alist-get 'go-mode apheleia-mode-alist) 'goimports)
  (setf (alist-get 'go-ts-mode apheleia-mode-alist) 'goimports))

;; Custom formatter selection based on project config
(defun hd/go-formatter ()
  "Return the appropriate Go formatter based on project config."
  (if (or (locate-dominating-file default-directory ".golangci.yml")
          (locate-dominating-file default-directory ".golangci.yaml")
          (locate-dominating-file default-directory ".golangci.toml")
          (locate-dominating-file default-directory ".golangci.json"))
      'golangci-lint-fmt
    'goimports))

;; Override LSP formatting with goimports/golangci-lint
(add-hook! '(go-mode-hook go-ts-mode-hook)
  (defun hd/go-set-formatter-h ()
    "Set Go formatter based on project configuration."
    (setq-local +format-with (hd/go-formatter))))
#+end_src

*** Docker (dockerfile-language-server + hadolint)

Use dockerfile-language-server-nodejs for LSP (formatting, completion, diagnostics)
and hadolint for additional linting.

#+begin_src emacs-lisp
;; Configure lsp-mode's built-in dockerfile client
(after! lsp-mode
  (require 'lsp-dockerfile nil t)
  (setq lsp-dockerfile-language-server-command '("docker-langserver" "--stdio")))

;; Use LSP formatting for Dockerfiles
(setq-hook! 'dockerfile-mode-hook +format-with 'lsp)

;; Enable LSP for dockerfile-mode
(add-hook 'dockerfile-mode-hook #'lsp!)

;; Additional linting with hadolint (complements LSP diagnostics)
(after! flycheck
  (flycheck-define-checker dockerfile-hadolint
    "A Dockerfile linter using hadolint."
    :command ("hadolint" "--format" "tty" "-")
    :standard-input t
    :error-patterns
    ((error line-start "-:" line " " (id (one-or-more alnum)) " error: " (message) line-end)
     (warning line-start "-:" line " " (id (one-or-more alnum)) " warning: " (message) line-end)
     (info line-start "-:" line " " (id (one-or-more alnum)) " info: " (message) line-end)
     (error line-start "-:" line " " (message) line-end))
    :modes dockerfile-mode)
  (add-to-list 'flycheck-checkers 'dockerfile-hadolint))
#+end_src

*** LTeX+ (Grammar & Spell Checking)

LSP-based grammar and spell checking using LanguageTool via ltex-ls-plus.
Supports org-mode, markdown, and LaTeX files.

#+begin_src emacs-lisp
(after! lsp-mode
  ;; Register ltex-ls-plus client
  (lsp-register-client
   (make-lsp-client
    :new-connection (lsp-stdio-connection '("ltex-ls-plus"))
    :activation-fn (lsp-activate-on "latex" "markdown" "org" "text")
    :major-modes '(org-mode markdown-mode gfm-mode latex-mode LaTeX-mode text-mode)
    :server-id 'ltex-plus
    :priority 1
    :initialization-options
    (lambda ()
      (list :settings
            (list :ltex
                  (list :language "en-US"
                        :additionalRules (list :motherTongue "pt-BR"
                                               :enablePickyRules t)
                        :completionEnabled t))))))

  ;; Custom function to change ltex language
  (defun hd/ltex-set-language (lang)
    "Set LTeX language for current buffer."
    (interactive
     (list (completing-read "Language: " '("en-US" "en-GB" "pt-BR") nil t)))
    (setq-local lsp-ltex-language lang)
    (lsp-workspace-restart (lsp--read-workspace))))

;; Enable ltex for writing modes (but not by default - manually activate)
(defun hd/enable-ltex ()
  "Enable LTeX LSP for current buffer."
  (interactive)
  (lsp))

;; Keybindings for ltex
(map! :leader
      (:prefix ("l" . "ltex")
       :desc "Enable LTeX" "l" #'hd/enable-ltex
       :desc "Set language" "L" #'hd/ltex-set-language))
#+end_src

*** Ansible (ansible-language-server)

LSP support for Ansible playbooks and roles.

#+begin_src emacs-lisp
;; Enable LSP for ansible files
(after! lsp-mode
  (setq lsp-ansible-add-on? t)  ; Work alongside yamlls
  (setq lsp-ansible-validation-enabled t))

;; Hook LSP to ansible-mode (activated by Doom's +ansible-yaml-mode project detection)
(add-hook 'ansible-mode-hook #'lsp!)
#+end_src

*** Helm Templates (helm-ls)

LSP support for Helm chart templates using helm-ls (via lsp-mode's built-in client).

#+begin_src emacs-lisp
;; Define a major mode for Helm templates (derived from yaml-mode)
(define-derived-mode helm-template-mode yaml-mode "Helm"
  "Major mode for editing Helm template files.")

;; Associate helm template files with helm-template-mode
(add-to-list 'auto-mode-alist '("/templates/.*\\.\\(ya?ml\\|tpl\\)\\'" . helm-template-mode))
(add-to-list 'auto-mode-alist '("Chart\\.yaml\\'" . helm-template-mode))
(add-to-list 'auto-mode-alist '("values.*\\.ya?ml\\'" . helm-template-mode))

;; Use LSP formatting for helm templates (helm-ls understands {{ }} syntax)
;; Disable apheleia to prevent prettier from being used
(after! apheleia
  (setf (alist-get 'helm-template-mode apheleia-mode-alist) nil))
(setq-hook! 'helm-template-mode-hook +format-with 'lsp)

;; Configure lsp-mode's built-in helm-ls client
(after! lsp-mode
  (require 'lsp-kubernetes-helm nil t)
  ;; Add helm-template-mode to the supported modes
  (add-to-list 'lsp-language-id-configuration '(helm-template-mode . "helm"))
  ;; Ensure helm_ls binary is found
  (setq lsp-kubernetes-helm-ls-server-path "helm_ls")
  ;; Enable built-in YAML LS for formatting (understands {{ }} syntax)
  (setq lsp-kubernetes-helm-yaml-ls-enable t))

;; Enable LSP for helm-template-mode
(add-hook 'helm-template-mode-hook #'lsp!)
#+end_src

** Projectile

#+begin_src emacs-lisp
(setq projectile-project-search-path '("~/src/work" "~/src/personal" "~/.local/share/chezmoi"))
#+end_src

** Auth Sources

#+begin_src emacs-lisp
(setq auth-sources '("~/.authinfo.gpg"))
#+end_src

* Packages
** Wakatime

#+begin_src emacs-lisp
(global-wakatime-mode)
#+end_src

* Chezmoi Integration

Integration with chezmoi dotfile manager. Provides template overlays,
diff/ediff tools, and convenient file operations.

** Age Encryption

Transparent age encryption support for editing encrypted chezmoi files.
Uses the same identity file as chezmoi (~/.config/chezmoi/key.txt).

#+begin_src emacs-lisp
(use-package! age
  :demand t
  :config
  ;; Use the same identity file as chezmoi
  (setq age-program "age"
        age-default-identity "~/.config/chezmoi/key.txt"
        age-default-recipient "~/.config/chezmoi/key.txt")

  ;; Enable age.el globally for .age files
  (age-file-enable))
#+end_src

** Chezmoi Package

#+begin_src emacs-lisp
(use-package! chezmoi
  :defer t
  :config
  ;; Enable template value overlays in chezmoi source files
  (setq chezmoi-template-display-p t))

;; Keybindings under SPC c z
(map! :leader
      (:prefix ("c z" . "chezmoi")
       :desc "Find file" "f" #'chezmoi-find
       :desc "Write (apply)" "w" #'chezmoi-write
       :desc "Diff" "d" #'chezmoi-diff
       :desc "Ediff" "e" #'chezmoi-ediff
       :desc "Sync" "s" #'chezmoi-sync-files
       :desc "Open in magit" "g" #'chezmoi-magit-status
       :desc "Toggle template" "t" #'chezmoi-template-buffer-display))

;; Auto-enable chezmoi-mode for files in chezmoi source directory
(add-hook 'find-file-hook
          (lambda ()
            (when (and buffer-file-name
                       (string-match-p "/\\.local/share/chezmoi/" buffer-file-name))
              (chezmoi-mode 1))))
#+end_src

* Brewfile Mode

Syntax highlighting for Homebrew Brewfiles. Uses ruby-mode as base with
additional highlighting for Brewfile-specific keywords.

#+begin_src emacs-lisp
(define-derived-mode brewfile-mode ruby-mode "Brewfile"
  "Major mode for editing Homebrew Brewfiles."
  (font-lock-add-keywords
   nil
   '(;; Brewfile commands
     ("^\\s-*\\(tap\\|brew\\|cask\\|mas\\)\\s-" 1 font-lock-keyword-face)
     ;; Package names (strings after commands)
     ("\\(tap\\|brew\\|cask\\|mas\\)\\s-+\\(\"[^\"]+\"\\)" 2 font-lock-string-face)
     ;; Options keywords
     ("\\b\\(args\\|restart_service\\|link\\|conflicts_with\\):" 1 font-lock-builtin-face)
     ;; Common option values
     (":\\(changed\\|loaded\\|no_quarantine\\)\\b" 1 font-lock-constant-face)
     ;; App Store IDs
     ("\\bid:\\s-*\\([0-9]+\\)" 1 font-lock-constant-face))))

;; Associate Brewfile patterns with brewfile-mode
(add-to-list 'auto-mode-alist '("Brewfile\\'" . brewfile-mode))
(add-to-list 'auto-mode-alist '("Brewfile\\.[a-z]+\\'" . brewfile-mode))
(add-to-list 'auto-mode-alist '("\\.Brewfile\\'" . brewfile-mode))
#+end_src

* Org Visual Enhancements

Make org-mode look beautiful with modern styling, variable-pitch fonts for prose,
and visual hierarchy through heading sizes.

** Org Modern

Replace org-superstar with org-modern for better visual styling of headlines,
keywords, tables, and source blocks. Uses efficient text properties instead of
character composition.

#+begin_src emacs-lisp
(use-package! org-modern
  :hook (org-mode . org-modern-mode)
  :config
  (setq org-modern-star '("◉" "○" "◈" "◇" "✳")
        org-modern-list '((43 . "➤") (45 . "–") (42 . "•"))
        org-modern-tag t
        org-modern-priority t
        org-modern-todo t
        org-modern-table t))
#+end_src

** Org Appear

Show emphasis markers only when cursor is on them. This gives you clean
rendered text while still being able to edit markers easily.

#+begin_src emacs-lisp
(use-package! org-appear
  :hook (org-mode . org-appear-mode)
  :config
  (setq org-appear-autoemphasis t
        org-appear-autolinks t
        org-appear-autosubmarkers t))
#+end_src

** Visual Settings

#+begin_src emacs-lisp
(after! org
  ;; Hide emphasis markers (*bold*, /italic/, etc.) for cleaner look
  (setq org-hide-emphasis-markers t)

  ;; Custom ellipsis for folded sections
  (setq org-ellipsis " ▾")

  ;; Prettier priorities
  (setq org-priority-faces
        '((?A . (:foreground "#ff6b6b" :weight bold))
          (?B . (:foreground "#feca57"))
          (?C . (:foreground "#48dbfb"))))

  ;; Start org files with all headings folded
  (setq org-startup-folded 'content)

  ;; Indent content under headings
  (setq org-startup-indented t)

  ;; Don't show line numbers in org-mode (cleaner for writing)
  (add-hook 'org-mode-hook (lambda () (display-line-numbers-mode -1))))
#+end_src

** Mixed Pitch (Variable + Fixed Fonts)

Use variable-pitch (proportional) font for prose and fixed-pitch for code,
tables, and other elements that need alignment.

#+begin_src emacs-lisp
(add-hook 'org-mode-hook 'variable-pitch-mode)
(add-hook 'org-mode-hook 'visual-line-mode)

(after! org
  ;; Ensure these elements stay in fixed-pitch
  (custom-set-faces!
    '(org-block :inherit fixed-pitch)
    '(org-block-begin-line :inherit fixed-pitch)
    '(org-block-end-line :inherit fixed-pitch)
    '(org-code :inherit fixed-pitch)
    '(org-table :inherit fixed-pitch :family nil)
    '(org-verbatim :inherit fixed-pitch)
    '(org-special-keyword :inherit fixed-pitch)
    '(org-meta-line :inherit fixed-pitch)
    '(org-checkbox :inherit fixed-pitch)
    '(org-property-value :inherit fixed-pitch)
    '(org-drawer :inherit fixed-pitch)
    '(org-date :inherit fixed-pitch)
    '(org-formula :inherit fixed-pitch))

  ;; Make table contents use fixed-pitch including whitespace
  (defun hd/org-fixed-pitch-table ()
    "Apply fixed-pitch to table regions for proper alignment."
    (font-lock-add-keywords
     nil
     '(("^[ \t]*\\(|.*|\\)[ \t]*$"
        (0 'fixed-pitch append)))
     'append))
  (add-hook 'org-mode-hook #'hd/org-fixed-pitch-table))
#+end_src

** Align All Tables

Utility function to align all tables in the current buffer.

#+begin_src emacs-lisp
(defun hd/org-align-all-tables ()
  "Align all tables in the current org buffer."
  (interactive)
  (org-table-map-tables 'org-table-align 'quietly))

(map! :after org
      :map org-mode-map
      :localleader
      :desc "Align all tables" "b a" #'hd/org-align-all-tables)
#+end_src

** Heading Sizes

Create visual hierarchy with scaled heading sizes.

#+begin_src emacs-lisp
(after! org
  (custom-set-faces!
    '(org-level-1 :inherit outline-1 :height 1.4)
    '(org-level-2 :inherit outline-2 :height 1.3)
    '(org-level-3 :inherit outline-3 :height 1.2)
    '(org-level-4 :inherit outline-4 :height 1.1)
    '(org-level-5 :inherit outline-5 :height 1.05)
    '(org-document-title :height 1.6 :weight bold)))
#+end_src

** Centered Writing (Olivetti)

Center org content like a word processor with comfortable margins.
Use =SPC t z= for additional zen/focus mode (hides modeline, etc.).

#+begin_src emacs-lisp
(use-package! olivetti
  :hook (org-mode . olivetti-mode)
  :config
  (setq olivetti-body-width 100
        olivetti-minimum-body-width 80
        olivetti-style 'fancy))
#+end_src

* Org Mode
** Path Configuration

Set org directories based on machine type.

#+begin_src emacs-lisp
(setq org-directory (if (hd/work-machine-p)
                        hd/org-work-dir
                      (expand-file-name "agenda" hd/org-personal-dir)))

(setq org-agenda-files
      (if (hd/work-machine-p)
          (list (expand-file-name "agenda.org" hd/org-work-dir)
                (expand-file-name "inbox.org" hd/org-work-dir))
        (list (expand-file-name "agenda.org" (expand-file-name "agenda" hd/org-personal-dir))
              (expand-file-name "inbox.org" (expand-file-name "agenda" hd/org-personal-dir)))))
#+end_src

** Tags

Define tag shortcuts for fast tagging.

#+begin_src emacs-lisp
(after! org
  (setq org-tag-alist
        (if (hd/work-machine-p)
            '(("@meeting" . ?m) ("@project" . ?p) ("@review" . ?r)
              ("@admin" . ?a) ("@pending" . ?w) ("@report" . ?d))
          '(("@home" . ?h) ("@errands" . ?e) ("@online" . ?o)
            ("@health" . ?H) ("@finance" . ?f) ("@someday" . ?s)
            ("@waiting" . ?w) ("@learning" . ?l)))))
#+end_src

** Capture Templates

#+begin_src emacs-lisp
(after! org
  (setq org-capture-templates
        (if (hd/work-machine-p)
            ;; Work templates
            '(("t" "Task" entry (file "inbox.org")
               "* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("m" "Meeting" entry (file "inbox.org")
               "* TODO %? :@meeting:\nSCHEDULED: %^t\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("p" "Pending Reply" entry (file "inbox.org")
               "* TODO %? :@pending:\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("r" "Review" entry (file "inbox.org")
               "* TODO %? :@review:\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("a" "Admin" entry (file "inbox.org")
               "* TODO %? :@admin:\n:PROPERTIES:\n:CREATED: %U\n:END:")
              ("d" "Report" entry (file "inbox.org")
               "* TODO %? :@report:\n:PROPERTIES:\n:CREATED: %U\n:END:"))
          ;; Personal templates
          '(("t" "Task" entry (file "inbox.org")
             "* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("h" "Home" entry (file "inbox.org")
             "* TODO %? :@home:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("e" "Errand" entry (file "inbox.org")
             "* TODO %? :@errands:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("o" "Online" entry (file "inbox.org")
             "* TODO %? :@online:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("H" "Health" entry (file "inbox.org")
             "* TODO %? :@health:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("f" "Finance" entry (file "inbox.org")
             "* TODO %? :@finance:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("s" "Someday" entry (file "inbox.org")
             "* TODO %? :@someday:\n:PROPERTIES:\n:CREATED: %U\n:END:")
            ("l" "Learning" entry (file "inbox.org")
             "* TODO %? :@learning:\n:PROPERTIES:\n:CREATED: %U\n:END:")))))
#+end_src

** Custom Agenda Commands

#+begin_src emacs-lisp
(after! org-agenda
  (setq org-agenda-custom-commands
        (if (hd/work-machine-p)
            ;; Work agenda commands
            '(("W" "Work Agenda"
               ((agenda "" ((org-agenda-span 'day)))
                (tags-todo "+@pending" ((org-agenda-overriding-header "Awaiting Reply")))
                (tags-todo "+@meeting" ((org-agenda-overriding-header "Meetings")))
                (tags-todo "+@review" ((org-agenda-overriding-header "Reviews")))
                (tags-todo "+@project" ((org-agenda-overriding-header "Projects")))
                (tags-todo "+@admin" ((org-agenda-overriding-header "Admin")))
                (tags-todo "+@report" ((org-agenda-overriding-header "Reports")))))
              ("Wp" "Pending" tags-todo "+@pending")
              ("Wm" "Meetings" tags-todo "+@meeting")
              ("Wr" "Reviews" tags-todo "+@review"))
          ;; Personal agenda commands
          '(("P" "Personal Agenda"
             ((agenda "" ((org-agenda-span 'day)))
              (tags-todo "+@waiting" ((org-agenda-overriding-header "Waiting")))
              (tags-todo "+@errands" ((org-agenda-overriding-header "Errands")))
              (tags-todo "+@home" ((org-agenda-overriding-header "Home")))
              (tags-todo "+@health" ((org-agenda-overriding-header "Health")))
              (tags-todo "+@finance" ((org-agenda-overriding-header "Finance")))
              (tags-todo "+@learning" ((org-agenda-overriding-header "Learning")))))
            ("Ps" "Someday" tags-todo "+@someday")
            ("Pw" "Waiting" tags-todo "+@waiting")))))
#+end_src

** Archive Settings

#+begin_src emacs-lisp
(after! org
  (setq org-archive-location
        (if (hd/work-machine-p)
            (concat (expand-file-name "archive.org" hd/org-work-dir) "::* Archive")
          (concat (expand-file-name "archive.org" (expand-file-name "agenda" hd/org-personal-dir)) "::* Archive"))))
#+end_src

* Org-roam
** Directory Setup

#+begin_src emacs-lisp
(after! org-roam
  (setq org-roam-directory (expand-file-name "roam" hd/org-personal-dir))
  (setq org-roam-dailies-directory (expand-file-name "daily" hd/org-personal-dir)))
#+end_src

** Dailies Capture Templates

#+begin_src emacs-lisp
(after! org-roam-dailies
  (setq org-roam-dailies-capture-templates
        '(("d" "default" entry
           "* %<%H:%M> %?"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n"))
          ("t" "task" entry
           "* TODO %?"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n"))
          ("j" "journal" entry
           "* %<%H:%M> Journal :journal:\n%?"
           :target (file+head "%<%Y-%m-%d>.org"
                              "#+title: %<%Y-%m-%d %A>\n#+filetags: :daily:\n\n")))))
#+end_src

** Keybindings

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("r" . "roam")
       :desc "Find node" "f" #'org-roam-node-find
       :desc "Insert link" "i" #'org-roam-node-insert
       :desc "Today" "t" #'org-roam-dailies-goto-today
       :desc "Yesterday" "y" #'org-roam-dailies-goto-yesterday
       :desc "Date" "d" #'org-roam-dailies-goto-date
       :desc "Capture today" "c" #'org-roam-dailies-capture-today))
#+end_src

** Git Auto-sync

Automatically commit and push changes to org-personal repo.

*** Core Functions

#+begin_src emacs-lisp
(defvar hd/org-sync-timer nil "Timer for debounced commit.")
(defvar hd/org-sync-delay 60 "Seconds to wait after save before commit.")

(defun hd/org-sync-commit-and-push ()
  "Stage, commit, and push changes."
  (let ((default-directory hd/org-personal-dir))
    (when (and (bound-and-true-p hd/org-personal-dir)
               (file-exists-p (expand-file-name ".git" hd/org-personal-dir)))
      (start-process "org-sync-add" nil "git" "add" "-A")
      (set-process-sentinel
       (start-process "org-sync-commit" nil "git" "commit" "-m"
                      (format "auto: %s" (format-time-string "%Y-%m-%d %H:%M")))
       (lambda (proc event)
         (when (string-match-p "finished" event)
           (start-process "org-sync-push" nil "git" "push")))))))

(defun hd/org-sync-pull ()
  "Commit pending changes, then pull latest."
  (let ((default-directory hd/org-personal-dir))
    (when (and (bound-and-true-p hd/org-personal-dir)
               (file-exists-p (expand-file-name ".git" hd/org-personal-dir)))
      ;; Cancel pending timer and commit first
      (when hd/org-sync-timer
        (cancel-timer hd/org-sync-timer)
        (setq hd/org-sync-timer nil))
      ;; Synchronous commit before pull
      (call-process "git" nil nil nil "add" "-A")
      (call-process "git" nil nil nil "commit" "-m"
                    (format "auto: %s" (format-time-string "%Y-%m-%d %H:%M")))
      ;; Pull with rebase
      (call-process "git" nil nil nil "pull" "--rebase"))))

(defun hd/org-sync-schedule-commit ()
  "Schedule a commit after delay (debounced)."
  (when hd/org-sync-timer (cancel-timer hd/org-sync-timer))
  (setq hd/org-sync-timer
        (run-with-timer hd/org-sync-delay nil #'hd/org-sync-commit-and-push)))
#+end_src

*** Save Hook

#+begin_src emacs-lisp
(defun hd/org-sync-after-save ()
  "Trigger sync if file is in org-personal."
  (when (and buffer-file-name
             (bound-and-true-p hd/org-personal-dir)
             (string-prefix-p (expand-file-name hd/org-personal-dir)
                              (expand-file-name buffer-file-name)))
    (hd/org-sync-schedule-commit)))

(add-hook 'after-save-hook #'hd/org-sync-after-save)
#+end_src

*** Pull Before Open

#+begin_src emacs-lisp
(after! org-roam
  (advice-add 'org-roam-node-find :before (lambda (&rest _) (hd/org-sync-pull)))
  (advice-add 'org-roam-dailies-goto-today :before (lambda (&rest _) (hd/org-sync-pull)))
  (advice-add 'org-roam-dailies-goto-yesterday :before (lambda (&rest _) (hd/org-sync-pull)))
  (advice-add 'org-roam-dailies-goto-date :before (lambda (&rest _) (hd/org-sync-pull))))
#+end_src